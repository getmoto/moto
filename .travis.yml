language: python
sudo: false
services:
  - docker
python:
  - 2.7
  - 3.6
env:
    - TEST_SERVER_MODE=false DOCKER_VERSION=17.06
    - TEST_SERVER_MODE=true DOCKER_VERSION=17.06
before_install:
  - export BOTO_CONFIG=/dev/null
install:
  - docker run -d --privileged --net host --name ci-docker docker:$DOCKER_VERSION-dind dockerd -H tcp://localhost:27015
  - docker run -d --name registry -p 5000:5000 registry
  - docker run -d -p 5001:5001 --name registry2 -v `pwd`/tests/certs:/certs -e "REGISTRY_AUTH=htpasswd" -e "REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm" -e REGISTRY_AUTH_HTPASSWD_PATH=/certs/htpasswd -e REGISTRY_HTTP_ADDR=0.0.0.0:5001 -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/registry.crt -e REGISTRY_HTTP_TLS_KEY=/certs/registry.key registry:2
  - travis_retry pip install boto==2.45.0
  - travis_retry pip install boto3
  - travis_retry pip install .
  - travis_retry pip install -r requirements-dev.txt
  - travis_retry pip install coveralls==1.1
  - |
    if [ "$TEST_SERVER_MODE" = "true" ]; then
      AWS_SECRET_ACCESS_KEY=server_secret AWS_ACCESS_KEY_ID=server_key moto_server -p 5000&
      export AWS_SECRET_ACCESS_KEY=foobar_secret
      export AWS_ACCESS_KEY_ID=foobar_key
    fi
script:
  - DOCKER_HOST=tcp://localhost:27015 make test
after_success:
  - coveralls
