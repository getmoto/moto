From bf15437c8a30fc8b0afebf97a509d22d45da1e94 Mon Sep 17 00:00:00 2001
From: Bert Blommers <info@bertblommers.nl>
Date: Thu, 19 Oct 2023 22:22:07 +0000
Subject: [PATCH] Patch hardcoded endpoints

---
 internal/conns/config.go      | 16 ++++++++++++++++
 internal/provider/provider.go |  4 ++--
 2 files changed, 18 insertions(+), 2 deletions(-)

diff --git a/internal/conns/config.go b/internal/conns/config.go
index b376ffacae..f41d4fee3f 100644
--- a/internal/conns/config.go
+++ b/internal/conns/config.go
@@ -58,12 +58,28 @@ type Config struct {
 	UseFIPSEndpoint                bool
 }

+
+// XXX: added by bblommers
+func GetLocalEndpoints() map[string]string {
+	const localEndpoint = "http://localhost:4566"
+	var localEndpoints = map[string]string{}
+	for _, name := range names.Aliases() {
+		localEndpoints[name] = localEndpoint
+	}
+	return localEndpoints
+}
+
+
 // ConfigureProvider configures the provided provider Meta (instance data).
 func (c *Config) ConfigureProvider(ctx context.Context, client *AWSClient) (*AWSClient, diag.Diagnostics) {
 	var diags diag.Diagnostics

 	ctx, logger := logging.NewTfLogger(ctx)

+	// XXX: added by bblommers
+	// insert custom endpoints
+	c.Endpoints = GetLocalEndpoints()
+
 	awsbaseConfig := awsbase.Config{
 		AccessKey:                     c.AccessKey,
 		AllowedAccountIds:             c.AllowedAccountIds,
diff --git a/internal/provider/provider.go b/internal/provider/provider.go
index 0bcb6d6a98..78b088c68e 100644
--- a/internal/provider/provider.go
+++ b/internal/provider/provider.go
@@ -462,13 +462,13 @@ func configure(ctx context.Context, provider *schema.Provider, d *schema.Resourc
 		CustomCABundle:                 d.Get("custom_ca_bundle").(string),
 		EC2MetadataServiceEndpoint:     d.Get("ec2_metadata_service_endpoint").(string),
 		EC2MetadataServiceEndpointMode: d.Get("ec2_metadata_service_endpoint_mode").(string),
-		Endpoints:                      make(map[string]string),
+		Endpoints:                      conns.GetLocalEndpoints(),  // XXX: added by bblommers
 		HTTPProxy:                      d.Get("http_proxy").(string),
 		Insecure:                       d.Get("insecure").(bool),
 		MaxRetries:                     25, // Set default here, not in schema (muxing with v6 provider).
 		Profile:                        d.Get("profile").(string),
 		Region:                         d.Get("region").(string),
-		S3UsePathStyle:                 d.Get("s3_use_path_style").(bool),
+		S3UsePathStyle:                 true,
 		SecretKey:                      d.Get("secret_key").(string),
 		SkipCredsValidation:            d.Get("skip_credentials_validation").(bool),
 		SkipRegionValidation:           d.Get("skip_region_validation").(bool),
--
2.34.1

